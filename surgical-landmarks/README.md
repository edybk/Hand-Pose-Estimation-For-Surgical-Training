# Using Hand Pose Estimation To Automate Surgical Training Feedback

Prerequisites:
- Setup [detection](../detection/README.md) with MMDetection and validate the test results
- Setup [pose estimation](../pose/README.md) with MMPose and validate the test results
- Download the videos of Open Surgery Simulation Dataset from [Scalpel's website](https://scalpel.group) and setup the following environment variables:
    - _FRONTAL_VIDEOS_ to the root folder of the videos
        ```
        export FRONTAL_VIDEOS=<path_to_videos>
        ```
    - _REPOSITORY_ROOT_ to the root of this repository
        ```
        export REPOSITORY_ROOT=<path_to_repository_root>
        ```

Reproducing the experiments:
- Setup the environment
    ```
    conda env create -f surgical-landmarks.yml
    conda activate surgical-landmarks
    ```
- Option 1: Generating the pose dataset from scratch based on the trained detection and pose models
    ```
    python generate_dataset.py
    ```
    to visualize the detections run with --draw true

- Option 2: Downloading the pre-generated dataset of detections+keypoints and I3D features for both views
    ```
    python download_dataset.py --download_location <download_destination>
    ```

- Training a multi-task action segmentation model

    |                 	| Accuracy     	| Edit  	| F1@0.1 	| F1@0.25 	| F1@0.5 	| Command                                                                                                                                                                                                                                                                                                                                                                                                    	|
    |-----------------	|--------------	|-------	|--------	|---------	|--------	|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	|
    |                 	|              	|       	|        	|         	|        	|                                                                                                                                                                                                                                                                                                                                                                                                            	|
    | Frontal         	|              	|       	|        	|         	|        	|                                                                                                                                                                                                                                                                                                                                                                                                            	|
    | Keypoints       	| 81.22 ± 5.61 	| 83.61 	| 86.39  	| 82.62   	| 67.41  	| python run.py --action train --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 96 --custom-features smooth_final --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split all --num_epochs 150 --eval-rate 1                                                                                                                                                        	|
    | I3D             	| 83.11 ± 5.84 	| 86.35 	| 89.10  	| 86.18   	| 73.76  	| python run.py --action train --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 2048 --custom-features i3d_frontal_split --append_split_to_features --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split all --num_epochs 150 --eval-rate 1                                                                                                                      	|
    | I3D + Keypoints 	| 83.24 ± 6.11 	| 85.60 	| 88.33  	| 84.90   	| 71.85  	| python run.py --action train --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 2144 --custom-features i3d_frontal_split --append_split_to_features --appended-features $REPOSITORY_ROOT/surgical-landmarks/data/apas_tcn_v2/appended_features/smooth_final.json --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split all --num_epochs 150 --eval-rate 1         	|
    | Closeup         	|              	|       	|        	|         	|        	|                                                                                                                                                                                                                                                                                                                                                                                                            	|
    | Keypoints       	| 84.16 ± 5.37 	| 79.95 	| 84.25  	| 82.02   	| 72.63  	| python run.py --action train --dataset apas_tcn_v2 --custom-features smooth_final_closeup --features_dim 96 --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --model MHTCN2 --multitask --split all --num_epochs 150 --eval-rate 1                                                                                                                      	|
    | I3D             	| 87.16 ± 4.72 	| 84.66 	| 89.70  	| 88.33   	| 82.10  	| python run.py --action train --dataset apas_tcn_v2 --features_dim 2048 --custom-features i3d_closeup_split --append_split_to_features --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --model MHTCN2 --multitask --split all --num_epochs 150 --eval-rate 1                                                                                                                      	|
    | I3D + Keypoints 	| 87.69 ± 4.40 	| 83.32 	| 88.16  	| 86.72   	| 79.99  	| python run.py --action train --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 2144 --custom-features i3d_closeup_split --append_split_to_features --appended-features $REPOSITORY_ROOT/surgical-landmarks/data/apas_tcn_v2/appended_features/smooth_final_closeup.json --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split all --num_epochs 150 --eval-rate 1 	|
    | Multi-View      	|              	|       	|        	|         	|        	|                                                                                                                                                                                                                                                                                                                                                                                                            	|
    | Keypoints       	| 85.39 ± 4.35 	| 81.63 	| 85.76  	| 84.16   	| 75.83  	| python run.py --action train --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 192 --appended-features $REPOSITORY_ROOT/surgical-landmarks/data/apas_tcn_v2/appended_features/smooth_final_closeup.json --custom-features smooth_final --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split all --num_epochs 150 --eval-rate 1                                  	|
    | I3D             	| 87.89 ± 4.13 	| 85.76 	| 90.61  	| 89.08   	| 82.82  	| python run.py --action train --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 4096 --custom-features i3d_both_split --append_split_to_features --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split all --num_epochs 150 --eval-rate 1                                                                                                                         	|
    | I3D + Keypoints 	| 88.35 ± 4.15 	| 85.32 	| 89.68  	| 88.28   	| 82.32  	| python run.py --action train --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 4288 --custom-features i3d_both_split --append_split_to_features --appended-features $REPOSITORY_ROOT/surgical-landmarks/data/apas_tcn_v2/appended_features/smooth_final_multiview.json --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split all --num_epochs 150 --eval-rate 1  	|

- Testing a multi-task action segmentation model with pretrained weights

    |                 	| Split1 	| Split2 	| Split3 	| Split4 	| Split5 	| Command Template                                                                                                                                                                                                                                                                                                                                                                                           	|    	|
    |-----------------	|--------	|--------	|--------	|--------	|--------	|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	|----	|
    |                 	|        	|        	|        	|        	|        	|                                                                                                                                                                                                                                                                                                                                                                                                            	|    	|
    | Frontal         	|        	|        	|        	|        	|        	|                                                                                                                                                                                                                                                                                                                                                                                                            	|    	|
    | Keypoints       	| [14RmFXHyYuM-9Xuhh0UI-3radbwn5tNbh](https://drive.google.com/file/d/14RmFXHyYuM-9Xuhh0UI-3radbwn5tNbh/view?usp=share_link)      	| [1gASBOSBNPQPEi8vLLLNP-kKI3qEI4NVQ](https://drive.google.com/file/d/1gASBOSBNPQPEi8vLLLNP-kKI3qEI4NVQ/view?usp=share_link)      	| [1sLAYXhR6BJUgp8hQDlZb9ew3M-ODpcpD](https://drive.google.com/file/d/1sLAYXhR6BJUgp8hQDlZb9ew3M-ODpcpD/view?usp=share_link)      	| [16krqrBaPmc7LYkCHBdmeIoIXTfcyPFKt](https://drive.google.com/file/d/16krqrBaPmc7LYkCHBdmeIoIXTfcyPFKt/view?usp=share_link)      	| [1sU0dAvfGYYiFD6qpuFcHDQvjtop5TEo_](https://drive.google.com/file/d/1sU0dAvfGYYiFD6qpuFcHDQvjtop5TEo_/view?usp=share_link)      	| python run.py --action test --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 96 --custom-features smooth_final --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split `split_number` --ckpt `ckpt_path_or_id`                                                                                                                                        	|    	|
    | I3D             	| [19nNvqim4s4sLuKLNTgyzPdBhVV6Wavr5](https://drive.google.com/file/d/19nNvqim4s4sLuKLNTgyzPdBhVV6Wavr5/view?usp=share_link)      	| [1T57A44llXukxm_82ImZ5ByCfZUlNPjqB](https://drive.google.com/file/d/1T57A44llXukxm_82ImZ5ByCfZUlNPjqB/view?usp=share_link)      	| [1RzDnoUiwQZMaO93NiwrC7GUz8Sjs5mX2](https://drive.google.com/file/d/1RzDnoUiwQZMaO93NiwrC7GUz8Sjs5mX2/view?usp=share_link)      	| [1jsDUH4SlAOO1Eyk2aOJmkIDazUZQ8fpX](https://drive.google.com/file/d/1jsDUH4SlAOO1Eyk2aOJmkIDazUZQ8fpX/view?usp=share_link)      	| [17BNBXNDe4s7U1gCJUZKBIEa7XhiO1nZM](https://drive.google.com/file/d/17BNBXNDe4s7U1gCJUZKBIEa7XhiO1nZM/view?usp=share_link)      	| python run.py --action test --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 2048 --custom-features i3d_frontal_split`split_number` --append_split_to_features --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split `split_number` --ckpt `ckpt_path_or_id`                                                                                   	|    	|
    | I3D + Keypoints 	| [1Cfjz4-67hQIbI1fhQvoGyBVAOszHAhUb](https://drive.google.com/file/d/1Cfjz4-67hQIbI1fhQvoGyBVAOszHAhUb/view?usp=share_link)      	| [1DBYClvG4y9UGSe9fUMvGzU1PTU9D-Ivg](https://drive.google.com/file/d/1DBYClvG4y9UGSe9fUMvGzU1PTU9D-Ivg/view?usp=share_link)      	| [1SQfzM9nvfmSugZHqz7_n4WHVUorbjKRu](https://drive.google.com/file/d/1SQfzM9nvfmSugZHqz7_n4WHVUorbjKRu/view?usp=share_link)      	| [1ByJo41khTG26m7A_6lX-Th8ZLb7C6Lea](https://drive.google.com/file/d/1ByJo41khTG26m7A_6lX-Th8ZLb7C6Lea/view?usp=share_link)      	| [1eOFbDttgnwcRlu-hO23UredA_95lOq0p](https://drive.google.com/file/d/1eOFbDttgnwcRlu-hO23UredA_95lOq0p/view?usp=share_link)      	| python run.py --action test --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 2144 --custom-features i3d_frontal_split`split_number` --append_split_to_features --appended-features $REPOSITORY_ROOT/surgical-landmarks/data/apas_tcn_v2/appended_features/smooth_final.json --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split `split_number` --ckpt `ckpt_path_or_id`         	| \| 	|
    | Closeup         	|        	|        	|        	|        	|        	|                                                                                                                                                                                                                                                                                                                                                                                                            	|    	|
    | Keypoints       	| [1vcpOAeglF6NenyW6h6rAmnOf1YiecUNr](https://drive.google.com/file/d/1vcpOAeglF6NenyW6h6rAmnOf1YiecUNr/view?usp=share_link)      	| [1ZyHSJcJB8CHyx0QmEGucXHOhka-LkgpS](https://drive.google.com/file/d/1ZyHSJcJB8CHyx0QmEGucXHOhka-LkgpS/view?usp=share_link)      	| [14XDy1_b3y3AhEWQ9xSpDnxPIvEwHupx_](https://drive.google.com/file/d/14XDy1_b3y3AhEWQ9xSpDnxPIvEwHupx_/view?usp=share_link)      	| [1umCvgf8M25A5y6DvAd4vcSIQ8GLhFCiQ](https://drive.google.com/file/d/1umCvgf8M25A5y6DvAd4vcSIQ8GLhFCiQ/view?usp=share_link)      	| [1VplNvUYrp91SfKVE7onD6LGygZqynpEg](https://drive.google.com/file/d/1VplNvUYrp91SfKVE7onD6LGygZqynpEg/view?usp=share_link)      	| python run.py --action test --dataset apas_tcn_v2 --custom-features smooth_final_closeup --features_dim 96 --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --model MHTCN2 --multitask --split `split_number` --ckpt `ckpt_path_or_id`                                                                                                 	|    	|
    | I3D             	| [1koWhB7FaKvQCz_8qJSl1yPmx1thcjSF9](https://drive.google.com/file/d/1koWhB7FaKvQCz_8qJSl1yPmx1thcjSF9/view?usp=share_link)      	| [1X3MI21HlRRvl4fkTby5NXrp4hQ8V1FeT](https://drive.google.com/file/d/1X3MI21HlRRvl4fkTby5NXrp4hQ8V1FeT/view?usp=share_link)      	| [1U9hRsPyBHMDIbZnAXxZWtD8nYhPDwPB8](https://drive.google.com/file/d/1U9hRsPyBHMDIbZnAXxZWtD8nYhPDwPB8/view?usp=share_link)      	| [1Qs-Xk-kc3bXlOByZlV6RNrMZ7l7DOSUF](https://drive.google.com/file/d/1Qs-Xk-kc3bXlOByZlV6RNrMZ7l7DOSUF/view?usp=share_link)      	| [1LAuKET3xeFvQzMqMSaNfbWz0Pj1UgDS0](https://drive.google.com/file/d/1LAuKET3xeFvQzMqMSaNfbWz0Pj1UgDS0/view?usp=share_link)      	| python run.py --action test --dataset apas_tcn_v2 --features_dim 2048 --custom-features i3d_closeup_split`split_number` --append_split_to_features --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --model MHTCN2 --multitask --split `split_number` --ckpt `ckpt_path_or_id`                                                                                                                    	|    	|
    | I3D + Keypoints 	| [164ukemU_Fq0hBUAg1jPtH6Ag7uCahHyr](https://drive.google.com/file/d/164ukemU_Fq0hBUAg1jPtH6Ag7uCahHyr/view?usp=share_link)      	| [21nRbjThs6EvSF39WN4IXZcmJYL03EoXXQ](https://drive.google.com/file/d/1nRbjThs6EvSF39WN4IXZcmJYL03EoXXQ/view?usp=share_link)      	| [1kB-gkfVAe-I5kA6zC7UBoafedgRNcqN9](https://drive.google.com/file/d/1kB-gkfVAe-I5kA6zC7UBoafedgRNcqN9/view?usp=share_link)      	| [1AP1Hqm2WXKUXOFNqKf7DEDMNUJRRpswc](https://drive.google.com/file/d/1AP1Hqm2WXKUXOFNqKf7DEDMNUJRRpswc/view?usp=share_link)      	| [1GF9VUbmyWAnWvjWlLeU9ieijnIIiYsf0](https://drive.google.com/file/d/1GF9VUbmyWAnWvjWlLeU9ieijnIIiYsf0/view?usp=share_link)      	| python run.py --action test --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 2144 --custom-features i3d_closeup_split`split_number` --append_split_to_features --appended-features $REPOSITORY_ROOT/surgical-landmarks/data/apas_tcn_v2/appended_features/smooth_final_closeup.json --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split `split_number` --ckpt `ckpt_path_or_id`   	|    	|
    | Multi-View      	|        	|        	|        	|        	|        	|                                                                                                                                                                                                                                                                                                                                                                                                            	|    	|
    | Keypoints       	| [1DVV1eJHldA7JbNGaKgLgfbQkfFvzWsd1](https://drive.google.com/file/d/1DVV1eJHldA7JbNGaKgLgfbQkfFvzWsd1/view?usp=share_link)      	| [1ncW1mug-h0VzfgXC0-PdOIsKPBR_RhHo](https://drive.google.com/file/d/1ncW1mug-h0VzfgXC0-PdOIsKPBR_RhHo/view?usp=share_link)      	| [1apvD5Xy1T3KKnWa8kytWTC2yeUwDQrbB](https://drive.google.com/file/d/1apvD5Xy1T3KKnWa8kytWTC2yeUwDQrbB/view?usp=share_link)      	| [14BOuiccElLob0o1tYHvMq4GnLA8zJllD](https://drive.google.com/file/d/14BOuiccElLob0o1tYHvMq4GnLA8zJllD/view?usp=share_link)      	| [12Ex--6z0qU_WvjWebbi2iyaVGVsS2d8L](https://drive.google.com/file/d/12Ex--6z0qU_WvjWebbi2iyaVGVsS2d8L/view?usp=share_link)      	| python run.py --action test --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 192 --appended-features $REPOSITORY_ROOT/surgical-landmarks/data/apas_tcn_v2/appended_features/smooth_final_closeup.json --custom-features smooth_final --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split `split_number` --ckpt `ckpt_path_or_id`                                  	|    	|
    | I3D             	| [1oa5CyKZrs8qIMJLdQAjsA67q2xJxzJVM](https://drive.google.com/file/d/1oa5CyKZrs8qIMJLdQAjsA67q2xJxzJVM/view?usp=share_link)      	| [1JzVwhOuMpjyHNudnP5MtGEhvQcD77yyK](https://drive.google.com/file/d/1JzVwhOuMpjyHNudnP5MtGEhvQcD77yyK/view?usp=share_link)      	| [1ULEr1LnOQUvgBfTpPCryOV9sYQnvWeQW](https://drive.google.com/file/d/1ULEr1LnOQUvgBfTpPCryOV9sYQnvWeQW/view?usp=share_link)      	| [1YN-o-OazpQdO0wkerXwIDVnelP8LMdBB](https://drive.google.com/file/d/1YN-o-OazpQdO0wkerXwIDVnelP8LMdBB/view?usp=share_link)      	| [1y-TKwUnnMAfe7mB-ZLDb4g0MVG4Cr3Yq](https://drive.google.com/file/d/1y-TKwUnnMAfe7mB-ZLDb4g0MVG4Cr3Yq/view?usp=share_link)      	| python run.py --action test --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 4096 --custom-features i3d_both_split`split_number` --append_split_to_features --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split `split_number` --ckpt `ckpt_path_or_id`                                                                                                                         	|    	|
    | I3D + Keypoints 	| [1HTMZHVMATuabr0umGcGdEMlXiPY2YxDW](https://drive.google.com/file/d/1HTMZHVMATuabr0umGcGdEMlXiPY2YxDW/view?usp=share_link)      	| [1wPpKHAH_XfvPLsFFuiHn5cK_pKwZ95Ty](https://drive.google.com/file/d/1wPpKHAH_XfvPLsFFuiHn5cK_pKwZ95Ty/view?usp=share_link)      	| [1k7YH0vOaDD2sRW3J43kqjah0Ph5oTaL5](https://drive.google.com/file/d/1k7YH0vOaDD2sRW3J43kqjah0Ph5oTaL5/view?usp=share_link)      	| [1r61h2CvnnY4ULLATFiBgJnz4Y9AWWWJi](https://drive.google.com/file/d/1r61h2CvnnY4ULLATFiBgJnz4Y9AWWWJi/view?usp=share_link)      	| [1hA6DPUG-z7RuBUHLNY0bz9l2Wt62UgYL](https://drive.google.com/file/d/1hA6DPUG-z7RuBUHLNY0bz9l2Wt62UgYL/view?usp=share_link)      	| python run.py --action test --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 4288 --custom-features i3d_both_split`split_number` --append_split_to_features --appended-features $REPOSITORY_ROOT/surgical-landmarks/data/apas_tcn_v2/appended_features/smooth_final_multiview.json --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split `split_number` --ckpt `ckpt_path_or_id`   	|    	|

    Example command for testing Multi-Task action segmentation on I3D + Keypoints Multi-View on split 1
    ```
    python run.py --action test --model MHTCN2 --multitask --dataset apas_tcn_v2 --features_dim 4288 --custom-features i3d_both_split1 --append_split_to_features --appended-features $REPOSITORY_ROOT/surgical-landmarks/data/apas_tcn_v2/appended_features/smooth_final_multiview.json --num_layers_R=10 --num_layers_PG=11 --num_f_maps=64 --num_R=1 --lr=0.001 --split 1 --ckpt "1HTMZHVMATuabr0umGcGdEMlXiPY2YxDW"
    ```
- Visualizing the segmentation performance on a sample video

- Calculating surgical skill proxies

